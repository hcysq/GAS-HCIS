<script>
const root = document.getElementById('root');
const nav = document.getElementById('nav');
const btnLogout = document.getElementById('btnLogout');

let state = {
  me: null,
  route: 'login',
};

function isAuthed(){ return !!(state.me && state.me.ok); }

function goto(route){
  if (!isAuthed()){
    state.route='login';
    renderLogin();
    return;
  }
  state.route = route || 'dash';
  renderAppShell();
  setActiveTab(state.route);
  renderRoute(state.route);
}

function boot(){
  google.script.run.withSuccessHandler(res=>{
    if(!res || !res.ok){
      state.me=null;
      state.route='login';
      renderLogin();
      return;
    }
    state.me=res;
    goto('dash');
  }).authMe();
}

/* ===================== LOGIN ===================== */
function renderLogin(msg=''){
  nav.classList.add('hidden');
  btnLogout.classList.add('hidden');

  root.innerHTML=`
    <div class="card">
      <div style="font-size:18px;font-weight:900;margin-bottom:6px;">Masuk HCIS</div>
      <div class="muted" style="margin-bottom:12px;">Login menggunakan <b>NIP</b> dan <b>Password</b>.</div>

      ${msg ? `<div class="muted" style="color:#ffb4b4;margin-bottom:10px;">${escapeHtml(msg)}</div>` : ''}

      <div style="margin-bottom:10px;">
        <input id="nip" placeholder="NIP" autocomplete="username">
      </div>

      <div style="margin-bottom:12px;">
        <div class="input-wrap">
          <input id="pin" type="password" placeholder="Password" autocomplete="current-password">
          <button type="button" class="peek-btn" onclick="togglePassword('pin', this)" aria-label="Tampilkan password">
            üëÅÔ∏è
          </button>
        </div>
      </div>

      <button class="btn primary" onclick="login()">Masuk</button>
      <div class="muted" style="margin-top:12px;">Jika lupa password, hubungi Admin HC.</div>
    </div>
  `;

  // Optional: enter to submit
  setTimeout(()=>{
    const pin = document.getElementById('pin');
    if(pin){
      pin.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') login();
      });
    }
  }, 0);
}

function renderAppShell(){
  nav.classList.remove('hidden');
  btnLogout.classList.remove('hidden');
}

/* ===================== ROUTES ===================== */
function renderRoute(route){
  if(!isAuthed()) return renderLogin();

  if(route==='dash') return renderDashboard();
  if(route==='profil') return renderProfil();
  if(route==='settings'){
    if (typeof settingsResetState_ === 'function') settingsResetState_();
    return renderSettings(); // <- dari settings.html
  }

  // placeholders modul
  if(route==='projects') return renderPlaceholder_('Progres Proyek');
  if(route==='absensi') return renderPlaceholder_('Absensi');
  if(route==='welfare') return renderPlaceholder_('Kesejahteraan');
  if(route==='development') return renderPlaceholder_('Pengembangan');

  return renderDashboard();
}

/* ===================== DASHBOARD ===================== */
function renderDashboard(){
  const me = state.me;

  root.innerHTML=`
    <div class="card">
      <div style="font-weight:900;font-size:18px;">Assalamu'alaikum, ${escapeHtml(me.nama||me.nip)}</div>
      <div class="muted" style="margin-top:4px;">
        NIP: <b>${escapeHtml(me.nip)}</b> ‚Ä¢ Role: <b>${escapeHtml(me.role)}</b>
      </div>
      <div class="muted" style="margin-top:6px;">
        <span id="dashUnit">Unit: ‚Ä¶</span> ‚Ä¢ <span id="dashJabatan">Jabatan: ‚Ä¶</span>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px;">Fitur HCIS</div>

      <div class="tileGrid">
        <div class="tile" onclick="goto('projects')">
          <div class="tileIcon">üìå</div>
          <div>
            <div class="tileTitle">Progres Proyek</div>
            <div class="tileDesc">Program, milestone, task, laporan pekanan.</div>
          </div>
        </div>

        <div class="tile" onclick="goto('absensi')">
          <div class="tileIcon">üóìÔ∏è</div>
          <div>
            <div class="tileTitle">Absensi</div>
            <div class="tileDesc">Jadwal pekanan, hadir, lembur, cuti & izin.</div>
          </div>
        </div>

        <div class="tile" onclick="goto('welfare')">
          <div class="tileIcon">üí≥</div>
          <div>
            <div class="tileTitle">Kesejahteraan</div>
            <div class="tileDesc">Slip gaji, klaim, reimbursement, pinjaman.</div>
          </div>
        </div>

        <div class="tile" onclick="goto('development')">
          <div class="tileIcon">üéì</div>
          <div>
            <div class="tileTitle">Pengembangan</div>
            <div class="tileDesc">Onboarding, kinerja, LMS, psikotes.</div>
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:12px;">
        Catatan: detail tiap fitur akan kita isi bertahap setelah CORE stabil.
      </div>
    </div>
  `;

  // ringan: ambil unit/jabatan dari Masterdata
  google.script.run.withSuccessHandler(res=>{
    if(!res || !res.ok || !res.data) return;
    const d = res.data;
    const unit = (d['UNIT']||d['Unit']||'-');
    const jabatan = (d['JABATAN']||d['JABATAN STRUKTURAL']||d['JABATAN FUNGSIONAL']||'-');
    const elUnit = document.getElementById('dashUnit');
    const elJab = document.getElementById('dashJabatan');
    if (elUnit) elUnit.innerHTML = `Unit: <b>${escapeHtml(unit)}</b>`;
    if (elJab)  elJab.innerHTML  = `Jabatan: <b>${escapeHtml(jabatan)}</b>`;
  }).getProfilMasterdataSaya();
}


/* ===================== PROFIL BARU ===================== */
function renderProfil(){
  root.innerHTML = '<div class="card"><div class="muted">Memuat profil lengkap...</div></div>';

  google.script.run
    .withSuccessHandler(res => {
      if(!res || !res.ok || !res.data) {
        const msg = escapeHtml(res?.msg || 'Profil tidak dapat dimuat.');
        root.innerHTML = `
          <div class="card">
            <div style="color:#c0392b;font-weight:800;">Gagal memuat profil</div>
            <div class="muted" style="margin-top:6px;">${msg}</div>
            <div class="muted" style="margin-top:6px;">Data belum tersedia dari hasil pencarian USER_ID dan NIP sesi Anda.</div>
          </div>
        `;
        return;
      }

      renderProfilLayout_(res.data);
    })
    .getProfilMasterdataSaya();
}

function buildProfilPayload_(raw){
  const getVal = (keys)=> pick_(raw, keys);
  const tmtRaw = getVal(['TMT', 'TMT MASUK', 'TMT_MASUK', 'TMT KERJA']);
  const ttlRaw = getVal(['TTL']);
  const tempatLahir = getVal(['TEMPAT LAHIR', 'Tempat Lahir', 'TEMPAT_LAHIR']);
  const tglLahir = getVal(['TANGGAL LAHIR', 'Tgl Lahir', 'TANGGAL_LAHIR', 'TGL LAHIR', 'TGL_LAHIR', 'DOB']);

  const ttl = ttlRaw || [tempatLahir, formatDateReadable_(tglLahir)].filter(Boolean).join(', ');

  const emergency = {
    nama: getVal(['KONTAK DARURAT', 'KONTAK DARURAT NAMA', 'KONTAK_DARURAT_NAMA']),
    hubungan: getVal(['KONTAK DARURAT HUBUNGAN', 'KONTAK_DARURAT_HUBUNGAN', 'Hubungan Darurat']),
    hp: getVal(['KONTAK DARURAT HP', 'KONTAK_DARURAT_HP', 'HP DARURAT'])
  };

  return {
    summary: {
      nama: getVal(['NAMA', 'Nama']),
      nip: getVal(['NIP']),
      unit: getVal(['UNIT', 'Unit', 'UNIT KERJA', 'Unit Kerja']),
      jabatan: getVal(['JABATAN', 'JABATAN STRUKTURAL', 'JABATAN FUNGSIONAL']),
      status_kepeg: getVal(['STATUS KEPEGAWAIAN', 'STATUS_KEPEGAWAIAN', 'Status Kepegawaian']),
      tmt: formatDateReadable_(tmtRaw),
      masa_kerja: getVal(['MASA KERJA', 'MASA_KERJA']) || computeMasaKerja_(tmtRaw)
    },
    contact: {
      hp: getVal(['HP', 'NO HP', 'NO. HP', 'NO_HP']),
      wa: getVal(['WA', 'WHATSAPP', 'NO WA']),
      email: getVal(['EMAIL', 'Email']),
      alamatKtp: getVal(['ALAMAT KTP', 'Alamat KTP', 'KTP ADDRESS']),
      domisili: getVal(['DOMISILI', 'Alamat Domisili', 'ALAMAT DOMISILI']),
      kecamatan: getVal(['KECAMATAN', 'Kecamatan']),
      kab_kota: getVal(['KAB/KOTA', 'KABUPATEN/KOTA', 'Kota', 'KABUPATEN']),
      kode_pos: getVal(['KODE POS', 'KODE_POS', 'KODEPOS']),
      darurat: emergency
    },
    personal: {
      nik: getVal(['NIK']),
      ttl,
      gender: getVal(['GENDER', 'JK', 'JENIS KELAMIN', 'Jenis Kelamin']),
      status_nikah: getVal(['STATUS NIKAH', 'Status Nikah', 'STATUS PERNIKAHAN']),
      pendidikan_str: getVal(['PENDIDIKAN TERAKHIR', 'Pendidikan Terakhir']),
      bpjs_kes: getVal(['BPJS KESEHATAN', 'BPJS_KES']),
      bpjs_tk: getVal(['BPJS KETENAGAKERJAAN', 'BPJS_TK', 'BPJSTK'])
    },
    edu_formal: normalizeEduFormal_(getVal(['PENDIDIKAN FORMAL', 'PENDIDIKAN_FORMAL', 'pendFormal', 'EDU_FORMAL'])),
    edu_nonformal: normalizeEduNonFormal_(getVal(['PENDIDIKAN NONFORMAL', 'PENDIDIKAN NON-FORMAL', 'PENDIDIKAN_NONFORMAL', 'pendNonFormal', 'EDU_NONFORMAL']))
  };
}

function normalizeEduFormal_(val){
  const arr = parseEduArray_(val);
  return arr.map(x => ({
    level: x.level || x.jenjang || x.tingkat || '-',
    nama: x.nama || x.sekolah || x.institusi || '-',
    jur: x.jur || x.jurusan || '',
    thn: x.thn || x.tahun || x.year || '',
    link: x.link || x.url || x.ijazah || ''
  }));
}

function normalizeEduNonFormal_(val){
  const arr = parseEduArray_(val);
  return arr.map(x => ({
    nama: x.nama || x.pelatihan || x.program || '-',
    thn: x.thn || x.tahun || x.year || '',
    link: x.link || x.url || x.sertifikat || ''
  }));
}

function parseEduArray_(val){
  if (Array.isArray(val)) return val.filter(Boolean);
  if (typeof val === 'string' && val.trim()){
    try{
      const parsed = JSON.parse(val);
      if (Array.isArray(parsed)) return parsed.filter(Boolean);
    }catch(e){ /* ignore */ }
  }
  return [];
}

function formatDateReadable_(val){
  try{
    if(!val) return '';
    const dt = new Date(val);
    if (isNaN(dt)) return String(val || '');
    return dt.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
  }catch(e){
    return String(val || '');
  }
}

function renderProfilLayout_(d){
  const fallbackNotice = '<span class="muted">-</span>';
  const item = (lbl, val) => `
    <div style="display:flex; gap:12px; align-items:flex-start; padding:8px 0; border-bottom:1px solid #f0f0f0;">
      <div style="flex:1; color:#666; font-size:13px;">${escapeHtml(lbl)}</div>
      <div style="flex:1.5; font-weight:700; text-align:right;">${val || '-'}</div>
    </div>`;

  const linkIcon = (url) => url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener" style="text-decoration:none;">üîó</a>` : '-';

  const emergency = d.contact.darurat || {};
  const daruratNama = escapeHtml(emergency.nama || '-');
  const daruratHub = escapeHtml(emergency.hubungan || '-');
  const daruratHp = escapeHtml(emergency.hp || '-');

  const domisiliParts = [d.contact.domisili, d.contact.kecamatan, d.contact.kab_kota, d.contact.kode_pos].filter(Boolean);
  const domisiliStr = domisiliParts.length ? escapeHtml(domisiliParts.join(', ')) : '-';
  const domisiliOnly = escapeHtml(d.contact.domisili || '-');
  const kecamatan = escapeHtml(d.contact.kecamatan || '-');
  const kabKota = escapeHtml(d.contact.kab_kota || '-');
  const kodePos = escapeHtml(d.contact.kode_pos || '-');

  const rowsFormal = (d.edu_formal || []).map(x => `
    <tr>
      <td style="font-weight:700;">${escapeHtml(x.level || '-')}</td>
      <td>${escapeHtml(x.nama || '-')}</td>
      <td style="text-align:center;">${escapeHtml(x.thn || '-')}</td>
      <td style="text-align:center;">${linkIcon(x.link)}</td>
    </tr>
  `).join('');

  const rowsNon = (d.edu_nonformal || []).map(x => `
    <tr>
      <td>${escapeHtml(x.nama || '-')}</td>
      <td style="text-align:center;">${escapeHtml(x.thn || '-')}</td>
      <td style="text-align:center;">${linkIcon(x.link)}</td>
    </tr>
  `).join('');

  root.innerHTML = `
    <div class="card">
      <div style="font-weight:900; font-size:18px; margin-bottom:10px; color:#2c3e50;">Profil Karyawan</div>
      <div style="display:flex; flex-direction:column; gap:14px;">
        <div>
          <div style="font-weight:800; margin-bottom:6px;">Ringkasan Kepegawaian</div>
          ${item('Nama', escapeHtml(d.summary.nama || '-') )}
          ${item('NIP', escapeHtml(d.summary.nip || '-') )}
          ${item('Unit', escapeHtml(d.summary.unit || '-') )}
          ${item('Jabatan', escapeHtml(d.summary.jabatan || '-') )}
          ${item('Status Kepegawaian', escapeHtml(d.summary.status_kepeg || '-') )}
          ${item('TMT', escapeHtml(d.summary.tmt || '-') )}
          ${item('Masa Kerja', escapeHtml(d.summary.masa_kerja || '-') )}
        </div>

        <div>
          <div style="font-weight:800; margin-bottom:6px;">Data Pribadi</div>
          ${item('NIK', d.personal.nik ? escapeHtml(maskNIK_(d.personal.nik)) : fallbackNotice)}
          ${item('TTL', escapeHtml(d.personal.ttl || '-') )}
          ${item('Gender', escapeHtml(d.personal.gender || '-') )}
          ${item('Status Pernikahan', escapeHtml(d.personal.status_nikah || '-') )}
          ${item('BPJS Kesehatan', escapeHtml(d.personal.bpjs_kes || '-') )}
          ${item('BPJS Ketenagakerjaan', escapeHtml(d.personal.bpjs_tk || '-') )}
          ${item('Pendidikan Terakhir', escapeHtml(d.personal.pendidikan_str || '-') )}
        </div>

        <div>
          <div style="font-weight:800; margin-bottom:6px;">Kontak & Alamat</div>
          ${item('No. HP', escapeHtml(d.contact.hp || '-') )}
          ${item('WhatsApp', escapeHtml(d.contact.wa || '-') )}
          ${item('Email', escapeHtml(d.contact.email || '-') )}
          ${item('Alamat KTP', escapeHtml(d.contact.alamatKtp || '-') )}
          ${item('Alamat Domisili', domisiliOnly)}
          ${item('Kecamatan Domisili', kecamatan)}
          ${item('Kab/Kota Domisili', kabKota)}
          ${item('Kode Pos Domisili', kodePos)}
          ${item('Domisili (Ringkas)', domisiliStr)}
          ${item('Kontak Darurat - Nama', daruratNama)}
          ${item('Kontak Darurat - Hubungan', daruratHub)}
          ${item('Kontak Darurat - HP', daruratHp)}
        </div>

        <div>
          <div style="font-weight:800; margin-bottom:6px;">Riwayat Pendidikan</div>
          <div style="margin-bottom:6px; font-weight:700; color:#2c3e50;">Formal</div>
          <table style="width:100%; font-size:13px; border-collapse:collapse; margin-bottom:10px;">
            <tr style="text-align:left; color:#888; border-bottom:1px solid #eee;"><th>Jenjang</th><th>Nama</th><th style="text-align:center;">Tahun</th><th style="text-align:center;">Ijazah</th></tr>
            ${rowsFormal || `<tr><td colspan="4" style="text-align:center; padding:8px 0;">${fallbackNotice}</td></tr>`}
          </table>

          <div style="margin-bottom:6px; font-weight:700; color:#2c3e50;">Non-Formal</div>
          <table style="width:100%; font-size:13px; border-collapse:collapse;">
            <tr style="text-align:left; color:#888; border-bottom:1px solid #eee;"><th>Pelatihan</th><th style="text-align:center;">Tahun</th><th style="text-align:center;">Sertifikat</th></tr>
            ${rowsNon || `<tr><td colspan="3" style="text-align:center; padding:8px 0;">${fallbackNotice}</td></tr>`}
          </table>
        </div>
      </div>
    </div>`;
}
/* ===================== PLACEHOLDER ===================== */
function renderPlaceholder_(title){
  root.innerHTML = `
    <div class="card">
      <div style="font-weight:900;font-size:18px;">${escapeHtml(title)}</div>
      <div class="muted" style="margin-top:6px;">
        Modul ini akan kita isi setelah CORE beres (data + approval + UI detail).
      </div>
      <div style="margin-top:12px;">
        <button class="btn primary" onclick="goto('dash')">Kembali ke Dashboard</button>
      </div>
    </div>
  `;
}

/* ===================== NAV ===================== */
function setActiveTab(route){
  const tabs = nav.querySelectorAll('.tab');
  tabs.forEach(t=>t.classList.remove('active'));
  if(route==='dash') tabs[0]?.classList.add('active');
  else if(route==='profil') tabs[1]?.classList.add('active');
  else if(route==='settings') tabs[2]?.classList.add('active');
  else tabs[0]?.classList.add('active');
}
function go(route){ goto(route); }

/* ===================== AUTH ===================== */
function login(){
  const nip = document.getElementById('nip')?.value || '';
  const pin = document.getElementById('pin')?.value || '';

  google.script.run.withSuccessHandler(res=>{
    if(!res || !res.ok) return renderLogin(res?.msg || 'Login gagal');
    boot();
  }).authLogin(nip, pin);
}
function logout(){
  google.script.run.withSuccessHandler(()=>{
    if (typeof settingsResetState_ === 'function') settingsResetState_();
    state.me=null;
    state.route='login';
    renderLogin('Anda sudah keluar.');
  }).authLogout();
}

/* ===================== PEEK PASSWORD ===================== */
function togglePassword(inputId, btn){
  const input = document.getElementById(inputId);
  if(!input) return;
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  btn.textContent = isHidden ? 'üôà' : 'üëÅÔ∏è';
}

/* ===================== UTILS ===================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',
    "'":'&#39;','`':'&#x60;','=':'&#x3D;','/':'&#x2F;'
  }[s]));
}
function kv(label, value){
  return `
    <div style="display:flex;gap:10px;align-items:flex-start;margin:8px 0;">
      <div style="flex:0 0 160px;max-width:160px;" class="muted">${escapeHtml(label)}</div>
      <div style="flex:1;font-weight:800;color:rgba(255,255,255,.92);">${escapeHtml(value ?? '-')}</div>
    </div>
  `;
}
function pick_(obj, keys){
  for (const k of keys){
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)){
      const v = obj[k];
      if (v !== null && v !== undefined && String(v).trim() !== '') return v;
    }
  }
  return '';
}
function maskNIK_(nik){
  const s = String(nik).replace(/\s+/g,'').trim();
  if (s.length <= 4) return s;
  return '****-****-****-' + s.slice(-4);
}
function computeMasaKerja_(tmtVal){
  try{
    if(!tmtVal) return '-';
    const dt = new Date(tmtVal);
    if (isNaN(dt.getTime())) return '-';
    const now = new Date();
    let years = now.getFullYear() - dt.getFullYear();
    let months = now.getMonth() - dt.getMonth();
    if (months < 0){ years -= 1; months += 12; }
    if (years < 0) return '-';
    if (years === 0) return `${months} bulan`;
    return `${years} tahun ${months} bulan`;
  }catch(e){
    return '-';
  }
}

boot();
</script>
