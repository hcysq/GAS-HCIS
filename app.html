<script>
const root = document.getElementById('root');
const nav = document.getElementById('nav');
const btnLogout = document.getElementById('btnLogout');

let state = {
  me: null,
  route: 'login',
};

function isAuthed(){ return !!(state.me && state.me.ok); }

function goto(route){
  if (!isAuthed()){
    state.route='login';
    renderLogin();
    return;
  }
  state.route = route || 'dash';
  renderAppShell();
  setActiveTab(state.route);
  renderRoute(state.route);
}

function boot(){
  google.script.run.withSuccessHandler(res=>{
    if(!res || !res.ok){
      state.me=null;
      state.route='login';
      renderLogin();
      return;
    }
    state.me=res;
    goto('dash');
  }).authMe();
}

/* ===================== LOGIN ===================== */
function renderLogin(msg=''){
  nav.classList.add('hidden');
  btnLogout.classList.add('hidden');

  root.innerHTML=`
    <div class="card">
      <div style="font-size:18px;font-weight:900;margin-bottom:6px;">Masuk HCIS</div>
      <div class="muted" style="margin-bottom:12px;">Login menggunakan <b>NIP</b> dan <b>Password</b>.</div>

      ${msg ? `<div class="muted" style="color:#ffb4b4;margin-bottom:10px;">${escapeHtml(msg)}</div>` : ''}

      <div style="margin-bottom:10px;">
        <input id="nip" placeholder="NIP" autocomplete="username">
      </div>

      <div style="margin-bottom:12px;">
        <div class="input-wrap">
          <input id="pin" type="password" placeholder="Password" autocomplete="current-password">
          <button type="button" class="peek-btn" onclick="togglePassword('pin', this)" aria-label="Tampilkan password">
            üëÅÔ∏è
          </button>
        </div>
      </div>

      <button class="btn primary" onclick="login()">Masuk</button>
      <div class="muted" style="margin-top:12px;">Jika lupa password, hubungi Admin HC.</div>
    </div>
  `;

  // Optional: enter to submit
  setTimeout(()=>{
    const pin = document.getElementById('pin');
    if(pin){
      pin.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') login();
      });
    }
  }, 0);
}

function renderAppShell(){
  nav.classList.remove('hidden');
  btnLogout.classList.remove('hidden');
}

/* ===================== ROUTES ===================== */
function renderRoute(route){
  if(!isAuthed()) return renderLogin();

  if(route==='dash') return renderDashboard();
  if(route==='profil') return renderProfil();
  if(route==='settings'){
    if (typeof settingsResetState_ === 'function') settingsResetState_();
    return renderSettings(); // <- dari settings.html
  }

  // placeholders modul
  if(route==='projects') return renderPlaceholder_('Progres Proyek');
  if(route==='absensi') return renderPlaceholder_('Absensi');
  if(route==='welfare') return renderPlaceholder_('Kesejahteraan');
  if(route==='development') return renderPlaceholder_('Pengembangan');

  return renderDashboard();
}

/* ===================== DASHBOARD ===================== */
function renderDashboard(){
  const me = state.me;

  root.innerHTML=`
    <div class="card">
      <div style="font-weight:900;font-size:18px;">Assalamu'alaikum, ${escapeHtml(me.nama||me.nip)}</div>
      <div class="muted" style="margin-top:4px;">
        NIP: <b>${escapeHtml(me.nip)}</b> ‚Ä¢ Role: <b>${escapeHtml(me.role)}</b>
      </div>
      <div class="muted" style="margin-top:6px;">
        <span id="dashUnit">Unit: ‚Ä¶</span> ‚Ä¢ <span id="dashJabatan">Jabatan: ‚Ä¶</span>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px;">Fitur HCIS</div>

      <div class="tileGrid">
        <div class="tile" onclick="goto('projects')">
          <div class="tileIcon">üìå</div>
          <div>
            <div class="tileTitle">Progres Proyek</div>
            <div class="tileDesc">Program, milestone, task, laporan pekanan.</div>
          </div>
        </div>

        <div class="tile" onclick="goto('absensi')">
          <div class="tileIcon">üóìÔ∏è</div>
          <div>
            <div class="tileTitle">Absensi</div>
            <div class="tileDesc">Jadwal pekanan, hadir, lembur, cuti & izin.</div>
          </div>
        </div>

        <div class="tile" onclick="goto('welfare')">
          <div class="tileIcon">üí≥</div>
          <div>
            <div class="tileTitle">Kesejahteraan</div>
            <div class="tileDesc">Slip gaji, klaim, reimbursement, pinjaman.</div>
          </div>
        </div>

        <div class="tile" onclick="goto('development')">
          <div class="tileIcon">üéì</div>
          <div>
            <div class="tileTitle">Pengembangan</div>
            <div class="tileDesc">Onboarding, kinerja, LMS, psikotes.</div>
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:12px;">
        Catatan: detail tiap fitur akan kita isi bertahap setelah CORE stabil.
      </div>
    </div>
  `;

  // ringan: ambil unit/jabatan dari Masterdata
  google.script.run.withSuccessHandler(res=>{
    if(!res || !res.ok || !res.data) return;
    const d = res.data;
    const unit = (d['UNIT']||d['Unit']||'-');
    const jabatan = (d['JABATAN']||d['JABATAN STRUKTURAL']||d['JABATAN FUNGSIONAL']||'-');
    const elUnit = document.getElementById('dashUnit');
    const elJab = document.getElementById('dashJabatan');
    if (elUnit) elUnit.innerHTML = `Unit: <b>${escapeHtml(unit)}</b>`;
    if (elJab)  elJab.innerHTML  = `Jabatan: <b>${escapeHtml(jabatan)}</b>`;
  }).getProfilMasterdataSaya();
}


/* ===================== PROFIL BARU ===================== */
function renderProfil(){
  root.innerHTML = '<div class="card"><div class="muted">Memuat profil lengkap...</div></div>';
  
  google.script.run
    .withSuccessHandler(res => {
      if(!res || !res.ok) {
        root.innerHTML = `<div class="card"><div style="color:red">Gagal: ${res?.msg || 'Unknown error'}</div></div>`;
        return;
      }
      renderProfilV2(res.data);
    })
    .getProfilMasterdataSaya();
}

function renderProfilV2(d){
  // Helper render item
  const item = (lbl, val) => `
    <div style="display:flex; margin-bottom:6px; border-bottom:1px solid #eee; padding-bottom:4px;">
      <div style="flex:1; color:#666; font-size:13px;">${lbl}</div>
      <div style="flex:1.5; font-weight:600; text-align:right;">${val || '-'}</div>
    </div>`;
    
  const linkIcon = (url) => url ? `<a href="${url}" target="_blank" style="text-decoration:none;">üîó</a>` : '';

  // 1. BOX RINGKASAN
  const boxSummary = `
    <div class="card">
      <div style="font-weight:900; font-size:16px; margin-bottom:10px; color:#2c3e50;">Ringkasan Kepegawaian</div>
      ${item('Nama', d.summary.nama)}
      ${item('NIP', d.summary.nip)}
      ${item('Unit Kerja', d.summary.unit)}
      ${item('Jabatan', d.summary.jabatan)}
      ${item('Status', d.summary.status_kepeg)}
      ${item('Masa Kerja', d.summary.masa_kerja)}
    </div>`;

  // 2. BOX KONTAK
  const daruratStr = d.contact.darurat.nama ? 
    `${d.contact.darurat.nama} (${d.contact.darurat.hubungan}) - ${d.contact.darurat.hp}` : '-';
    
  const boxContact = `
    <div class="card">
      <div style="font-weight:900; font-size:16px; margin-bottom:10px; color:#2c3e50;">Kontak</div>
      ${item('No. HP', d.contact.hp)}
      ${item('WhatsApp', d.contact.wa)}
      ${item('Email', d.contact.email)}
      ${item('Domisili', `${d.contact.domisili}, ${d.contact.kecamatan}, ${d.contact.kab_kota}`)}
      ${item('Kontak Darurat', daruratStr)}
    </div>`;

  // 3. BOX PRIBADI
  // Masking NIK sederhana
  const nikMask = d.personal.nik ? d.personal.nik.substring(0,6) + '******' + d.personal.nik.substring(12) : '-';
  
  const boxPersonal = `
    <div class="card">
      <div style="font-weight:900; font-size:16px; margin-bottom:10px; color:#2c3e50;">Data Pribadi</div>
      ${item('NIK', nikMask)}
      ${item('TTL', d.personal.ttl)}
      ${item('Gender', d.personal.gender)}
      ${item('Status Pernikahan', d.personal.status_nikah)}
      ${item('Pend. Terakhir', d.personal.pendidikan_str)}
      ${item('BPJS Kesehatan', d.personal.bpjs_kes)}
      ${item('BPJS Ketenagakerjaan', d.personal.bpjs_tk)}
    </div>`;

  // 4. BOX PENDIDIKAN FORMAL (Table Style)
  let rowsFormal = d.edu_formal.map(x => `
    <tr>
      <td><b>${x.level}</b></td>
      <td>${x.nama}<br><small class="muted">${x.jur || ''}</small></td>
      <td>${x.thn}</td>
      <td>${linkIcon(x.link)}</td>
    </tr>
  `).join('');
  
  const boxEduFormal = `
    <div class="card">
      <div style="font-weight:900; font-size:16px; margin-bottom:10px; color:#2c3e50;">Riwayat Pendidikan Formal</div>
      <table style="width:100%; font-size:13px; border-collapse:collapse;">
        <tr style="text-align:left; color:#888;"><th>Jenjang</th><th>Nama/Jurusan</th><th>Thn</th><th>Dok</th></tr>
        ${rowsFormal || '<tr><td colspan="4" style="text-align:center;">Tidak ada data</td></tr>'}
      </table>
    </div>`;

  // 5. BOX NON FORMAL
  let rowsNon = d.edu_nonformal.map(x => `
    <tr>
      <td>${x.nama}<br><small class="muted">${x.prog || ''}</small></td>
      <td>${x.thn}</td>
      <td>${linkIcon(x.link)}</td>
    </tr>
  `).join('');

  const boxEduNon = `
    <div class="card">
      <div style="font-weight:900; font-size:16px; margin-bottom:10px; color:#2c3e50;">Pendidikan Non-Formal</div>
      <table style="width:100%; font-size:13px; border-collapse:collapse;">
        <tr style="text-align:left; color:#888;"><th>Pelatihan</th><th>Thn</th><th>Sert</th></tr>
        ${rowsNon || '<tr><td colspan="3" style="text-align:center;">Tidak ada data</td></tr>'}
      </table>
    </div>`;

  root.innerHTML = boxSummary + boxContact + boxPersonal + boxEduFormal + boxEduNon;
}
/* ===================== PLACEHOLDER ===================== */
function renderPlaceholder_(title){
  root.innerHTML = `
    <div class="card">
      <div style="font-weight:900;font-size:18px;">${escapeHtml(title)}</div>
      <div class="muted" style="margin-top:6px;">
        Modul ini akan kita isi setelah CORE beres (data + approval + UI detail).
      </div>
      <div style="margin-top:12px;">
        <button class="btn primary" onclick="goto('dash')">Kembali ke Dashboard</button>
      </div>
    </div>
  `;
}

/* ===================== NAV ===================== */
function setActiveTab(route){
  const tabs = nav.querySelectorAll('.tab');
  tabs.forEach(t=>t.classList.remove('active'));
  if(route==='dash') tabs[0]?.classList.add('active');
  else if(route==='profil') tabs[1]?.classList.add('active');
  else if(route==='settings') tabs[2]?.classList.add('active');
  else tabs[0]?.classList.add('active');
}
function go(route){ goto(route); }

/* ===================== AUTH ===================== */
function login(){
  const nip = document.getElementById('nip')?.value || '';
  const pin = document.getElementById('pin')?.value || '';

  google.script.run.withSuccessHandler(res=>{
    if(!res || !res.ok) return renderLogin(res?.msg || 'Login gagal');
    boot();
  }).authLogin(nip, pin);
}
function logout(){
  google.script.run.withSuccessHandler(()=>{
    if (typeof settingsResetState_ === 'function') settingsResetState_();
    state.me=null;
    state.route='login';
    renderLogin('Anda sudah keluar.');
  }).authLogout();
}

/* ===================== PEEK PASSWORD ===================== */
function togglePassword(inputId, btn){
  const input = document.getElementById(inputId);
  if(!input) return;
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  btn.textContent = isHidden ? 'üôà' : 'üëÅÔ∏è';
}

/* ===================== UTILS ===================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',
    "'":'&#39;','`':'&#x60;','=':'&#x3D;','/':'&#x2F;'
  }[s]));
}
function kv(label, value){
  return `
    <div style="display:flex;gap:10px;align-items:flex-start;margin:8px 0;">
      <div style="flex:0 0 160px;max-width:160px;" class="muted">${escapeHtml(label)}</div>
      <div style="flex:1;font-weight:800;color:rgba(255,255,255,.92);">${escapeHtml(value ?? '-')}</div>
    </div>
  `;
}
function pick_(obj, keys){
  for (const k of keys){
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)){
      const v = obj[k];
      if (v !== null && v !== undefined && String(v).trim() !== '') return v;
    }
  }
  return '';
}
function maskNIK_(nik){
  const s = String(nik).replace(/\s+/g,'').trim();
  if (s.length <= 4) return s;
  return '****-****-****-' + s.slice(-4);
}
function computeMasaKerja_(tmtVal){
  try{
    if(!tmtVal) return '-';
    const dt = new Date(tmtVal);
    if (isNaN(dt.getTime())) return '-';
    const now = new Date();
    let years = now.getFullYear() - dt.getFullYear();
    let months = now.getMonth() - dt.getMonth();
    if (months < 0){ years -= 1; months += 12; }
    if (years < 0) return '-';
    if (years === 0) return `${months} bulan`;
    return `${years} tahun ${months} bulan`;
  }catch(e){
    return '-';
  }
}

boot();
</script>
